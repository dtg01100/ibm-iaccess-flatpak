app-id: com.ibm.iaccess
runtime: org.freedesktop.Platform//24.08
sdk: org.freedesktop.Sdk//24.08
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk
modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk/install.sh
  - name: ibm-iaccess
    buildsystem: simple
    build-commands:
      - chmod -R u+rw,go+r . || true
      - install -D launch-ibmiaccess.sh /app/launch-ibmiaccess.sh
      - mkdir -p /app/IBMiAccess_v1r1
      - cp -r * /app/IBMiAccess_v1r1/
      - install -D ibm-iaccess.desktop /app/share/applications/com.ibm.iaccess.desktop
      - install -D /app/IBMiAccess_v1r1/Icons/logo128.png /app/share/icons/hicolor/128x128/apps/com.ibm.iaccess.png
      # Force external browser/file opener to use xdg-open (system default via portal)
      - echo "com.ibm.iaccess.browser=/usr/bin/xdg-open" >> /app/IBMiAccess_v1r1/AcsConfig.properties
      - echo "com.ibm.iaccess.fileopen=/usr/bin/xdg-open" >> /app/IBMiAccess_v1r1/AcsConfig.properties
      - echo "com.ibm.iaccess.javaAwtDesktopAllowed=false" >> /app/IBMiAccess_v1r1/AcsConfig.properties
    sources:
      - type: dir
        path: IBMiAccess_v1r1
      - type: file
        path: launch-ibmiaccess.sh
      - type: file
        path: ibm-iaccess.desktop
finish-args:
  # Set desktop environment to GNOME for proper Java GTK look-and-feel detection
  - --env=XDG_CURRENT_DESKTOP=GNOME
  - --env=DESKTOP_SESSION=gnome
  # Java options for Nimbus with GTK2 backend
  - --env=_JAVA_OPTIONS=-Dswing.defaultlaf=javax.swing.plaf.nimbus.NimbusLookAndFeel -Dawt.useSystemAAFontSettings=lcd -Dswing.aatext=true -Djdk.gtk.version=2
  # Allow both X11 and Wayland for better desktop compatibility
  - --socket=x11
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  # Access host filesystems for fonts and config
  - --filesystem=host
  - --filesystem=xdg-config/fontconfig:ro
  - --filesystem=xdg-config/gtk-3.0:ro
  - --socket=session-bus
  - --socket=system-bus
  - --device=dri
  - --env=JAVA_TOOLKIT=awt
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.portal.*
  - --metadata=X-Flatpak-Export-Desktop=true
command: "/app/launch-ibmiaccess.sh"
